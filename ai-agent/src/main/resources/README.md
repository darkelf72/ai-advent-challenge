# Скрипты мониторинга погоды

Этот набор скриптов предназначен для автоматического мониторинга погоды в крупнейших городах России с использованием GigaChat API и MCP сервера.

## Структура

**Скрипты (в каталоге `scripts/`):**
- `weather_monitoring.sh` - скрипт запроса погоды во всех городах (с сохранением в БД)
- `weather_summary.sh` - скрипт получения сводной информации о погоде из истории чата
- `weather_summary_query.sh` - **НОВЫЙ** скрипт запроса сводной информации из базы данных
- `stop_services.sh` - скрипт остановки приложений app и mcp-server

**Логи (в каталоге `logs/`):**
- `weather_monitoring.log` - лог файл мониторинга (создается автоматически)
- `weather_summary.log` - лог файл сводки (создается автоматически)
- `weather_summary_query.log` - **НОВЫЙ** лог файл запросов из БД (создается автоматически)
- `stop_services.log` - лог файл остановки сервисов (создается автоматически)

## Требования

- macOS
- Запущенные модули `app` и `mcp-server` (скрипты запустят их автоматически, если они не запущены)
- Настроенный GigaChat API ключ в `gradle.properties`

## Использование

### 1. Скрипт запроса погоды

Этот скрипт запрашивает погоду в 6 крупнейших городах России:
- Москва
- Санкт-Петербург
- Новосибирск
- Екатеринбург
- Казань
- Нижний Новгород

**Запуск:**
```bash
./weather_monitoring.sh
```

**Функции:**
- Автоматически проверяет, запущены ли приложения `app` и `mcp-server`
- Запускает их при необходимости
- Запрашивает погоду во всех городах один раз
- **Сохраняет каждый ответ в таблицу weather базы данных mcp-data.db**
- Логирует все запросы и ответы в `weather_monitoring.log`
- Завершается после получения всех данных

### 2. Скрипт сводной информации

Этот скрипт запрашивает у GigaChat сводную информацию о погоде на основе истории сообщений.

**Запуск:**
```bash
./weather_summary.sh
```

**Функции:**
- Запрашивает сводку о погоде из истории чата
- Логирует результат в `weather_summary.log`
- Показывает macOS уведомление с краткой сводкой

**Примечание:** Убедитесь, что приложение `app` запущено перед выполнением этого скрипта.

### 3. Скрипт запроса сводной информации из базы данных (НОВЫЙ)

Этот скрипт запрашивает у GigaChat сводную информацию из таблицы weather базы данных mcp-data.db за последние 30 минут.

**Запуск:**
```bash
./weather_summary_query.sh
```

**Функции:**
- Автоматически проверяет, запущены ли приложения `app` и `mcp-server`
- Запускает их при необходимости и проверяет успешный старт
- **Использует новый MCP tool `get_data_from_db` для получения данных из базы**
- Запрашивает сводную информацию из таблицы weather за последние 30 минут
- Логирует полный ответ в `weather_summary_query.log`
- Показывает macOS уведомление с развернутым ответом от приложения

**Технические детали:**
- Использует ISO 8601 формат времени для запроса периода
- Отправляет запрос: "Дай мне сводную информацию из таблицы weather за последние 30 минут"
- GigaChat автоматически вызывает tool `get_data_from_db` через MCP сервер
- MCP сервер выполняет SQL запрос к базе данных и возвращает JSON с записями
- GigaChat анализирует данные и формирует человекочитаемый ответ

**Подходит для запуска через cron** для периодической сводки по накопленным данным.

### 4. Скрипт остановки сервисов

Этот скрипт останавливает приложения `app` и `mcp-server`, запущенные на портах 9999 и 8082.

**Запуск:**
```bash
./stop_services.sh
```

**Функции:**
- Находит процессы, слушающие порты 9999 (app) и 8082 (mcp-server)
- Сначала пытается остановить процессы мягко (SIGTERM)
- Если процесс не останавливается в течение 10 секунд, использует принудительное завершение (SIGKILL)
- Логирует все действия в `stop_services.log`

**Использование:**
Запускайте этот скрипт, когда нужно остановить все сервисы после работы с погодными скриптами.

## Настройка для cron

Если вы хотите запускать скрипты по расписанию через cron:

1. Откройте crontab:
```bash
crontab -e
```

2. Добавьте строку для запроса погоды каждые 30 минут (с сохранением в БД):
```bash
*/30 * * * * /path/to/ai-advent-challenge/app/src/main/resources/scripts/weather_monitoring.sh
```

3. Для получения сводки из истории чата раз в час:
```bash
0 * * * * /path/to/ai-advent-challenge/app/src/main/resources/scripts/weather_summary.sh
```

4. **НОВОЕ:** Для получения сводки из базы данных каждый час:
```bash
0 * * * * /path/to/ai-advent-challenge/app/src/main/resources/scripts/weather_summary_query.sh
```

5. Для остановки сервисов в конце дня (например, в 23:00):
```bash
0 23 * * * /path/to/ai-advent-challenge/app/src/main/resources/scripts/stop_services.sh
```

## Логи

Все логи сохраняются в отдельном каталоге `app/src/main/resources/logs/`:
- `weather_monitoring.log` - содержит полную историю запросов погоды с временными метками
- `weather_summary.log` - содержит историю запросов сводной информации из истории чата
- `weather_summary_query.log` - **НОВЫЙ** содержит историю запросов сводной информации из базы данных
- `stop_services.log` - содержит историю остановки сервисов

**Расположение:** `app/src/main/resources/logs/`

**Формат лога:** `[YYYY-MM-DD HH:MM:SS] сообщение`

**Примечание:** Каталог `logs/` создается автоматически при первом запуске любого скрипта.

## База данных mcp-data.db

С добавлением новой функциональности, MCP сервер теперь использует SQLite базу данных для хранения погодных данных.

### Структура базы данных

**Таблица weather:**
- `id` - INTEGER PRIMARY KEY AUTOINCREMENT
- `content` - TEXT (JSON ответ от приложения app)
- `createdAt` - TIMESTAMP (время создания записи)

**Расположение:** `mcp-server/mcp-data.db`

**Миграции:** Управляются через Flyway, файлы миграций в `mcp-server/src/main/resources/db/migration/`

### Новый MCP Tool: get_data_from_db

Добавлен новый инструмент для работы с базой данных через MCP протокол.

**Параметры:**
- `tableName` (string) - название таблицы (например: "weather")
- `startTime` (string) - начало периода в ISO 8601 формате (например: "2025-12-18T10:00:00")
- `endTime` (string) - конец периода в ISO 8601 формате (например: "2025-12-18T11:00:00")

**Возвращает:** JSON массив записей из таблицы weather за указанный период

**Пример использования:**
```bash
curl -X POST "http://localhost:9999/api/send" \
  -H "Content-Type: application/json" \
  -d '{"message": "Дай мне сводную информацию из таблицы weather за последние 30 минут"}'
```

GigaChat автоматически распознает необходимость использования tool `get_data_from_db` и выполнит запрос к базе данных через MCP сервер.

## Технические детали

### weather_monitoring.sh

- Порт приложения: 9999
- Порт MCP сервера: 8082
- Пауза между запросами к одному серверу: 2 секунды
- Выполняет один цикл запросов и завершается
- **Сохраняет каждый ответ в базу данных mcp-data.db**

### weather_summary.sh

- Показывает macOS уведомления через `osascript`
- Обрезает текст уведомления до 200 символов для удобства чтения

### stop_services.sh

- Использует `lsof` для поиска процессов на портах
- Мягкое завершение через `kill` (SIGTERM)
- Принудительное завершение через `kill -9` (SIGKILL) если необходимо
- Таймаут ожидания завершения: 10 секунд

## Поддерживаемые города

Скрипт мониторинга запрашивает погоду для следующих координат:

| Город | Широта | Долгота |
|-------|--------|---------|
| Москва | 55.7558 | 37.6173 |
| Санкт-Петербург | 59.9311 | 30.3609 |
| Новосибирск | 55.0084 | 82.9357 |
| Екатеринбург | 56.8389 | 60.6057 |
| Казань | 55.8304 | 49.0661 |
| Нижний Новгород | 56.2965 | 43.9361 |

## Устранение неполадок

### Приложение не запускается

Если скрипт не может запустить приложение, проверьте:
1. Наличие GigaChat API ключа в `gradle.properties`
2. Правильность пути к проекту
3. Доступность портов 9999 и 8082

### Ошибки при получении погоды

Проверьте:
1. Доступность Open-Meteo API
2. Работоспособность MCP сервера (проверьте логи)
3. Корректность работы GigaChat API (проверьте квоту)

### Уведомления не показываются

Убедитесь, что:
1. Терминалу разрешено показывать уведомления в настройках macOS
2. `osascript` доступен в системе

## Архитектура решения

### Структура каталогов

```
app/src/main/resources/
├── scripts/               # Исполняемые скрипты
│   ├── weather_monitoring.sh
│   ├── weather_summary.sh
│   ├── weather_summary_query.sh
│   └── stop_services.sh
└── logs/                  # Лог файлы (создается автоматически)
    ├── weather_monitoring.log
    ├── weather_summary.log
    ├── weather_summary_query.log
    └── stop_services.log
```

### Обновленная архитектура с базой данных

```
┌─────────────────────────────────────────────────────────────┐
│              scripts/weather_monitoring.sh                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 1. Запрос погоды через app (порт 9999)             │   │
│  │ 2. app → GigaChat → MCP server → weather_in_city   │   │
│  │ 3. Получение ответа в JSON                         │   │
│  │ 4. Сохранение в mcp-data.db (таблица weather)      │   │
│  │ 5. Логирование в logs/weather_monitoring.log       │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                      mcp-data.db                             │
│  ┌────────────────────────────────────────────────────┐    │
│  │ Таблица: weather                                   │    │
│  │ - id (автоинкремент)                               │    │
│  │ - content (JSON ответ от app)                      │    │
│  │ - createdAt (timestamp)                            │    │
│  └────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│            scripts/weather_summary_query.sh                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 1. Запрос сводки через app (порт 9999)             │   │
│  │ 2. app → GigaChat → MCP server → get_data_from_db  │   │
│  │ 3. SQL запрос к mcp-data.db                        │   │
│  │ 4. Возврат JSON с записями за период               │   │
│  │ 5. GigaChat анализирует и формирует сводку         │   │
│  │ 6. Показ macOS уведомления с результатом           │   │
│  │ 7. Логирование в logs/weather_summary_query.log    │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### Компоненты системы

**MCP Server (порт 8082):**
- `DatabaseManager` - инициализация БД и Flyway миграции
- `WeatherDataService` - работа с таблицей weather
- `WeatherService` - получение погоды из Open-Meteo API
- MCP Tools:
  - `weather_in_city` - получение погоды по координатам
  - `get_data_from_db` - получение данных из БД за период

**App (порт 9999):**
- `GigaChatApiClient` - интеграция с GigaChat API
- Обработка function_call для всех MCP tools
- Роутинг запросов к MCP server через MCP Client

**База данных (SQLite):**
- Расположение: `mcp-server/mcp-data.db`
- Управление миграциями: Flyway
- Автоматическая инициализация при старте MCP сервера

### Поток данных

1. **Сбор данных:**
   - `weather_monitoring.sh` → app → GigaChat → MCP tool `weather_in_city`
   - Ответ → сохранение в БД через sqlite3

2. **Получение сводки:**
   - `weather_summary_query.sh` → app → GigaChat → MCP tool `get_data_from_db`
   - SQL запрос → JSON ответ → анализ GigaChat → человекочитаемая сводка

### Обработка ошибок

- Все ошибки в MCP сервере логируются, но не приводят к падению сервера
- Все ошибки в app при взаимодействии с MCP логируются
- При ошибке в tool возвращается пустой массив или сообщение об ошибке
- Скрипты проверяют успешность запросов и логируют ошибки
